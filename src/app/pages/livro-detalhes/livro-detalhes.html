<div class="detalhes-container" *ngIf="livro; else carregando">
  <!-- Mensagem de sucesso -->
  <div class="alert-success" *ngIf="mensagemSucesso">
    {{ mensagemSucesso }}
  </div>

  <div class="voltar-link">
    <a routerLink="/loja">← Voltar para a loja</a>
  </div>

  <div class="livro-content">
    
    <div class="livro-imagem">
      <img [src]="getImagemUrl()" [alt]="livro.titulo" [title]="livro.titulo">
    </div>
    <ng-template #firstPendingAvaliacao let-pa>
      <p class="meta"><strong>[Você]</strong><span class="muted">: {{ pa.data_avaliacao | date:'short' }}</span></p>
      <div class="rating">
        <div class="stars" aria-hidden="true">
          <i *ngFor="let n of [1,2,3,4,5]" [ngClass]="n <= (pa.nota || 0) ? 'fa-solid fa-star active' : 'fa-regular fa-star'"></i>
        </div>
        <div class="nota-num">Nota: {{ pa.nota }}</div>
      </div>
      <p class="conteudo">{{ pa.comentario }}</p>
      <p class="small-muted">Sua resenha está aguardando moderação e ficará visível após aprovação.</p>
    </ng-template>

    <div class="livro-info">
      <h1>{{ livro.titulo }}</h1>
      <p class="autor"><strong>Autor:</strong> {{ getAutorNome() }}</p>
      
      <p class="preco" *ngIf="temPreco()">R$ {{ livro.estoque.preco | number:'1.2-2' }}</p>
      <p class="preco no-price" *ngIf="!temPreco()">Preço sob consulta</p>
      
      <div class="botoes-acao">
        <button class="btn-adicionar" (click)="adicionarAoCarrinho()" [title]="'Adicionar ' + livro.titulo + ' ao carrinho'" [disabled]="!temPreco()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 18C5.9 18 5.01 18.9 5.01 20C5.01 21.1 5.9 22 7 22C8.1 22 9 21.1 9 20C9 18.9 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.63L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 5.48C20.96 5.34 21 5.17 21 5C21 4.45 20.55 4 20 4H5.21L4.27 2H1ZM17 18C15.9 18 15.01 18.9 15.01 20C15.01 21.1 15.9 22 17 22C18.1 22 19 21.1 19 20C19 18.9 18.1 18 17 18Z" fill="currentColor"/>
          </svg>
          Adicionar ao carrinho
        </button>
      </div>

      <div class="detalhes-tecnicos">
        <p><strong>Editora:</strong> {{ livro.editora || 'Não informada' }}</p>
        <p><strong>ISBN:</strong> {{ livro.isbn || 'Não informado' }}</p>
        <p><strong>Gênero:</strong> {{ getGeneroLabel() }}</p>
        <p><strong>Ano:</strong> {{ livro.ano_publicacao || 'Não informado' }}</p>
      </div>
      
      <div class="sinopse">
        <h2>Sinopse</h2>
        <p>{{ livro.sinopse || 'Sinopse não disponível.' }}</p>
      </div>
    </div>
  </div>

  <div class="resenhas-section">
    <h2>Resenhas</h2>
    <!-- Sua Avaliação em destaque (pendente) -->
    <div *ngIf="pendingAvaliacoes && pendingAvaliacoes.length > 0" class="sua-avaliacao-card">
      <div class="card-header">
        <div class="title">Sua Avaliação</div>
        <div class="status-wrapper">
          <span class="status-badge status-pendente"><i class="fa-regular fa-clock"></i> Pendente de Aprovação</span>
        </div>
      </div>
      <div class="card-body">
        <div class="sua-avaliacao-item">
          <ng-container *ngIf="pendingAvaliacoes && pendingAvaliacoes.length > 0">
            <ng-container *ngTemplateOutlet="firstPendingAvaliacao; context: { $implicit: pendingAvaliacoes[0] }"></ng-container>
          </ng-container>
        </div>
      </div>
    </div>

    <div *ngIf="avaliacoes.length > 0; else noAvaliacoes" class="lista-avaliacoes">
      <div *ngFor="let avaliacao of avaliacoes" class="resenha-item">
        <button *ngIf="authService.isAdmin()" class="delete-btn top-right" (click)="confirmDeleteAvaliacao(avaliacao)" [disabled]="avaliacao._deleting" aria-label="Excluir avaliação">
          <i class="fa-solid fa-trash"></i>
        </button>
        <p>
          <strong>{{ avaliacao.autor?.nome || 'Usuário' }}</strong>
          <span class="muted">: {{ avaliacao.data_avaliacao | date:'short' }}</span>
        </p>
        <div class="rating">
          <div class="stars" aria-hidden="true">
            <i *ngFor="let n of [1,2,3,4,5]" [ngClass]="n <= (avaliacao.nota || 0) ? 'fa-solid fa-star active' : 'fa-regular fa-star'"></i>
          </div>
          <div class="nota-num">Nota: {{ avaliacao.nota }}</div>
        </div>
        <p class="comentario-text">{{ avaliacao.comentario }}</p>
        <div class="comment-actions">
          <button class="like-btn" [class.liked]="avaliacao.userReaction === 'LIKE'" (click)="toggleReaction(avaliacao, 'LIKE')" [disabled]="avaliacao._reactionLoading" aria-label="Curtir avaliação">
            <i [ngClass]="avaliacao.userReaction === 'LIKE' ? 'fa-solid fa-thumbs-up' : 'fa-regular fa-thumbs-up'"></i>
            <small class="reaction-count">{{ avaliacao.likes ?? avaliacao.likesCount ?? 0 }}</small>
          </button>

          <button class="dislike-btn" [class.disliked]="avaliacao.userReaction === 'DISLIKE'" (click)="toggleReaction(avaliacao, 'DISLIKE')" [disabled]="avaliacao._reactionLoading" aria-label="Não curtir avaliação">
            <i [ngClass]="avaliacao.userReaction === 'DISLIKE' ? 'fa-solid fa-thumbs-down' : 'fa-regular fa-thumbs-down'"></i>
            <small class="reaction-count">{{ avaliacao.dislikes ?? 0 }}</small>
          </button>
        </div>
      </div>
    </div>
    <ng-template #noAvaliacoes>
      <p>Este livro ainda não tem avaliações. Seja o primeiro!</p>
    </ng-template>

    <hr>
    
    <app-avaliacao-form 
      [idLivro]="livroId" 
      (avaliacaoSalva)="onNovaAvaliacao($event)">
    </app-avaliacao-form>
  </div>
</div>

<ng-template #carregando>
  <p class="loading">Carregando detalhes do livro...</p>
</ng-template>