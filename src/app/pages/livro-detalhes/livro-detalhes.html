<div class="detalhes-container" *ngIf="livro; else carregando">
  <div class="voltar-link">
    <a routerLink="/loja">Voltar</a>
  </div>

  <div class="livro-content">
    
    <div class="livro-imagem">
      <img [src]="livro.capa_url || 'assets/placeholder.svg'" (error)="onImgError($event)" [alt]="livro.titulo">
    </div>

    <div class="livro-info">
      <h1>{{ livro.titulo }}</h1>
      <p class="autor">
        <strong>Autor{{ (livro.autores?.length || 0) > 1 ? 'es' : '' }}:</strong>
        <span *ngIf="livro.autores?.length; else autorFallback">
          <span *ngFor="let a of livro.autores; let i = index">
            {{ a.nome }}<span *ngIf="i < livro.autores.length - 1">, </span>
          </span>
        </span>
        <ng-template #autorFallback>{{ livro.autor?.nome || 'Autor desconhecido' }}</ng-template>
      </p>
      
  <p class="preco">R$ {{ livro.estoque?.preco || 'Preço indisponível' }}</p>
      
      <div class="botoes-acao">
        <button class="btn-adicionar" (click)="adicionarAoCarrinho()">Adicionar ao carrinho</button>
      </div>

      <div class="detalhes-tecnicos">
        <p><strong>Editora:</strong> {{ livro.editora || 'Não informada' }}</p>
        <p><strong>ISBN:</strong> {{ livro.isbn || 'Não informado' }}</p>
        <p>
          <strong>Gênero{{ (livro.generos?.length || 0) > 1 ? 's' : '' }}:</strong>
          <span *ngIf="livro.generos?.length; else noGenero">
            <span *ngFor="let g of livro.generos; let i = index">
              {{ g.nome }}<span *ngIf="i < livro.generos.length - 1">, </span>
            </span>
          </span>
          <ng-template #noGenero>Não informado</ng-template>
        </p>
        <p><strong>Ano:</strong> {{ livro.ano_publicacao || 'Não informado' }}</p>
      </div>
      
      <div class="sinopse">
        <h2>Sinopse</h2>
        <p>{{ livro.sinopse || 'Sinopse não disponível.' }}</p>
      </div>
    </div>
  </div>

  <div class="resenhas-section">
    <h2>Resenhas</h2>
    
    <div *ngIf="avaliacoes.length > 0; else noAvaliacoes" class="lista-avaliacoes">
      <div *ngFor="let avaliacao of avaliacoes" class="resenha-item">
        <p><strong>{{ avaliacao.autor?.nome || 'Usuário' }} (Nota: {{ avaliacao.nota }})</strong></p>
        <p>{{ avaliacao.comentario }}</p>
      </div>
    </div>
    <ng-template #noAvaliacoes>
      <p>Este livro ainda não tem avaliações. Seja o primeiro!</p>
    </ng-template>

    <hr>
    
    <app-avaliacao-form 
      [idLivro]="livroId" 
      (avaliacaoSalva)="onNovaAvaliacao($event)">
    </app-avaliacao-form>
  </div>
</div>

<ng-template #carregando>
  <p>Carregando detalhes do livro...</p>
</ng-template>